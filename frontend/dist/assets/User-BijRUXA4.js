import{o as ce,L as pe,c as L,b as o,w as s,e as m,f as u,u as ge,k as me,g as G,a as l,t as p,h as v,v as ve,j as fe,E as f}from"./index-15cpDDQA.js";import{a as w}from"./index-CKeea3vE.js";import{_ as we}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ye={class:"user-container"},_e={class:"card-header"},be={class:"user-info"},Se={class:"avatar-section"},Ce={style:{display:"inline-block",padding:"10px"}},Pe={class:"avatar-text"},he={class:"info-content"},ke={class:"info-item"},Ve={class:"info-item"},Ie={class:"info-item"},Ne={class:"info-item"},je={class:"info-item"},ze={class:"info-item"},Ue={class:"info-item"},Ae={class:"points"},Te={class:"info-item"},xe={class:"info-item"},$e={class:"pagination-container"},Re={class:"pagination-container"},De={class:"dialog-footer"},Fe={key:1,class:"no-data"},Be={class:"dialog-footer"},Ee={class:"dialog-footer"},O="https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=default%20user%20avatar%20simple%20gray%20portrait&image_size=square",He={__name:"User",setup(qe){const I=ge(),W=me(),n=u({studentId:"",name:"",college:"",major:"",grade:"",className:"",points:0,uploadCount:0,downloadCount:0,avatar:""}),K=fe(()=>{const a=n.value.major||"未设置",e=n.value.grade||"",t=e?`${e.slice(-2)}级`:"未设置",c=`${n.value.className||"未设置"}班`,i=n.value.name||"未设置";return`${a}${t}${c}${i}`}),P=u(!1),g=u({oldPassword:"",newPassword:"",confirmPassword:""}),A=u(null),Q=u({oldPassword:[{required:!0,message:"请输入原密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"新密码长度至少为6位",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:(a,e,t)=>{e!==g.value.newPassword?t(new Error("两次输入的密码不一致")):t()},trigger:"blur"}]}),N=u(!1),h=u({college:""}),T=u(null),X=u({college:[{required:!0,message:"请输入学院名称",trigger:"blur"}]}),j=u(!1),y=u({major:"",grade:""}),x=u(null),Y=u({major:[{required:!0,message:"请输入专业名称",trigger:"blur"}],grade:[{required:!0,message:"请输入年级",trigger:"blur"}]}),z=u([]),U=u([]),b=u([]),k=u(1),V=u(1),_=u(10),$=u(0),R=u(0),D=a=>a?new Date(a).toLocaleString():"",Z=async()=>{try{const a=typeof localStorage<"u"?localStorage.getItem("token"):"";if(!a){I.push("/login");return}n.value={studentId:"",name:"",major:"",grade:"",college:"",className:"",points:0,uploadCount:0,downloadCount:0,avatar:""},console.log("开始获取用户信息，token:",a);try{const e={headers:{Authorization:`Bearer ${a}`}},t=await w.get("/user/info",e);if(console.log("获取用户信息成功，响应:",t),t.data){console.log("用户信息:",t.data),console.log("用户信息中是否包含className字段:","className"in t.data),console.log("className字段的值:",t.data.className),console.log("className字段的类型:",typeof t.data.className),n.value=t.data,console.log("使用API返回的用户信息:",n.value),console.log("赋值后userInfo.className的值:",n.value.className),t.data.downloadCount!==void 0&&(n.value.downloadCount=t.data.downloadCount);try{const d=await w.get("/integral/user",e);console.log("获取积分信息成功:",d),d.data&&(n.value.points=d.data.totalPoints||n.value.points,n.value.uploadCount=d.data.uploadCount||0,console.log("已更新积分:",n.value.points),console.log("已更新上传次数:",n.value.uploadCount))}catch(d){console.error("获取积分信息失败:",d)}typeof localStorage<"u"&&(localStorage.setItem("user",JSON.stringify(n.value)),console.log("已更新localStorage中的用户信息"))}}catch(e){console.error("API调用失败:",e),typeof localStorage<"u"&&localStorage.removeItem("user")}}catch(a){console.error("获取用户信息失败:",a),I.push("/login")}},F=async()=>{try{const a=typeof localStorage<"u"?localStorage.getItem("token"):"";console.log("获取上传历史，token:",a);const e={page:k.value,pageSize:_.value};console.log("获取上传历史，参数:",e);const t={headers:{Authorization:`Bearer ${a}`}};console.log("获取上传历史，配置:",t),console.log("开始调用API...");const d=await w.get("/user/uploadHistory",{params:e});console.log("获取上传历史成功:",d),console.log("资料列表:",d.data.list),console.log("资料总数:",d.data.total),d.data&&d.data.list&&Array.isArray(d.data.list)?(d.data.list.forEach((c,i)=>{console.log(`资料${i+1}:`,c),console.log(`资料${i+1}分类名称:`,c.categoryName)}),z.value=d.data.list.map(c=>({id:c.id,name:c.name,categoryName:c.categoryName||"未分类",uploadTime:c.createTime,downloadCount:c.downloadCount,points:c.points||20})),$.value=d.data.total):(console.error("获取上传历史失败: response.data.list 不存在或不是数组"),z.value=[],$.value=0),console.log("上传历史数据处理完成:",z.value)}catch(a){console.error("获取上传历史失败:",a)}},B=async()=>{try{const a=typeof localStorage<"u"?localStorage.getItem("token"):"";console.log("获取下载历史，token:",a);const e={page:V.value,pageSize:_.value};console.log("获取下载历史，参数:",e);const t={headers:{Authorization:`Bearer ${a}`}};console.log("获取下载历史，配置:",t),console.log("开始调用API...");const d=await w.get("/user/downloadHistory",{params:e});console.log("获取下载历史成功:",d),console.log("下载历史列表:",d.data.list),console.log("下载历史总数:",d.data.total),d.data&&d.data.list&&Array.isArray(d.data.list)?(U.value=d.data.list,R.value=d.data.total):(console.error("获取下载历史失败: response.data.list 不存在或不是数组"),U.value=[],R.value=0),console.log("下载历史数据处理完成:",U.value)}catch(a){console.error("获取下载历史失败:",a)}},ee=async()=>{try{const a=typeof localStorage<"u"?localStorage.getItem("token"):"";console.log("获取密码修改记录，token:",a);const e={headers:{Authorization:`Bearer ${a}`}};console.log("获取密码修改记录，配置:",e),console.log("开始调用API...");const t=await w.get("/user/password/history");console.log("获取密码修改记录成功:",t),t.data&&Array.isArray(t.data)?(b.value=t.data,console.log("密码修改记录数据:",b.value)):(console.error("获取密码修改记录失败: response.data 不存在或不是数组"),b.value=[])}catch(a){console.error("获取密码修改记录失败:",a),b.value=[]}},oe=a=>{_.value=a,k.value=1,F()},ae=a=>{k.value=a,F()},le=a=>{_.value=a,V.value=1,B()},se=a=>{V.value=a,B()},te=()=>{P.value=!0},re=async()=>{T.value&&await T.value.validate(async a=>{if(a)try{const e=await w.post("/user/updateCollege",{college:h.value.college});e.code===200?(n.value.college=h.value.college,typeof localStorage<"u"&&localStorage.setItem("user",JSON.stringify(n.value)),f.success("学院修改成功!"),N.value=!1):f.error(e.message||"学院修改失败!")}catch(e){console.error("学院修改失败:",e),f.error("学院修改失败!")}})},ne=async()=>{x.value&&await x.value.validate(async a=>{if(a)try{const e=await w.post("/user/updateMajorGrade",{major:y.value.major,grade:y.value.grade});e.code===200?(n.value.major=y.value.major,n.value.grade=y.value.grade,typeof localStorage<"u"&&localStorage.setItem("user",JSON.stringify(n.value)),f.success("专业和年级修改成功!"),j.value=!1):f.error(e.message||"专业和年级修改失败!")}catch(e){console.error("专业和年级修改失败:",e),f.error("专业和年级修改失败!")}})},de=async()=>{A.value&&await A.value.validate(async a=>{if(a)try{const e=await w.post("/user/updatePwd",{oldPassword:g.value.oldPassword,newPassword:g.value.newPassword});e.code===200?(f.success("密码修改成功!"),P.value=!1,g.value={oldPassword:"",newPassword:"",confirmPassword:""}):f.error(e.message||"密码修改失败!")}catch(e){console.error("密码修改失败:",e),f.error("密码修改失败!")}})},ue=async()=>{try{console.log("开始退出登录..."),console.log("localStorage中的token:",localStorage.getItem("token")),console.log("localStorage中的user:",localStorage.getItem("user"));const a=await w.post("/user/logout");if(console.log("退出登录响应:",a),W.path.startsWith("/admin"))try{console.log("当前在Admin页面，强制触发登录记录刷新...");const e=await w.get("/admin/login/records",{params:{page:1,pageSize:10}});console.log("强制刷新登录记录成功:",e),await new Promise(t=>setTimeout(t,2500))}catch(e){console.error("强制刷新登录记录失败:",e),await new Promise(t=>setTimeout(t,1500))}else await new Promise(e=>setTimeout(e,500));localStorage.removeItem("user"),localStorage.removeItem("token"),f.success("退出登录成功"),I.push("/login")}catch(a){console.error("退出登录失败:",a),console.error("错误详情:",a.response),console.error("错误消息:",a.message),localStorage.removeItem("user"),localStorage.removeItem("token"),f.success("退出登录成功"),I.push("/login")}};ce(()=>{M()}),pe(()=>{M()});const M=async()=>{await Z(),await F(),await B(),await ee()};return(a,e)=>{const t=m("el-button"),d=m("el-avatar"),c=m("el-card"),i=m("el-table-column"),E=m("el-table"),J=m("el-pagination"),S=m("el-input"),C=m("el-form-item"),H=m("el-form"),q=m("el-dialog"),ie=m("el-empty");return G(),L("div",ye,[o(c,{class:"user-info-card"},{header:s(()=>[l("div",_e,[e[17]||(e[17]=l("span",null,"用户信息",-1)),o(t,{type:"primary",onClick:te},{default:s(()=>[...e[16]||(e[16]=[v("修改密码",-1)])]),_:1})])]),default:s(()=>[l("div",be,[l("div",Se,[l("div",Ce,[o(d,{size:120,src:O},{default:s(()=>[l("img",{src:O,alt:"头像"})]),_:1}),l("div",Pe,p(K.value),1),o(t,{type:"default",onClick:ue,style:{"margin-top":"10px"}},{default:s(()=>[...e[18]||(e[18]=[v(" 账户切换 ",-1)])]),_:1})])]),l("div",he,[l("div",ke,[e[19]||(e[19]=l("span",{class:"label"},"学号：",-1)),l("span",null,p(n.value.studentId),1)]),l("div",Ve,[e[20]||(e[20]=l("span",{class:"label"},"姓名：",-1)),l("span",null,p(n.value.name),1)]),l("div",Ie,[e[21]||(e[21]=l("span",{class:"label"},"学院：",-1)),l("span",null,p(n.value.college||"未设置"),1)]),l("div",Ne,[e[22]||(e[22]=l("span",{class:"label"},"专业：",-1)),l("span",null,p(n.value.major||"未设置"),1)]),l("div",je,[e[23]||(e[23]=l("span",{class:"label"},"年级：",-1)),l("span",null,p(n.value.grade||"未设置"),1)]),l("div",ze,[e[24]||(e[24]=l("span",{class:"label"},"班级：",-1)),l("span",null,p(n.value.className||"未设置"),1)]),l("div",Ue,[e[25]||(e[25]=l("span",{class:"label"},"积分：",-1)),l("span",Ae,p(n.value.points),1)]),l("div",Te,[e[26]||(e[26]=l("span",{class:"label"},"上传资料数：",-1)),l("span",null,p(n.value.uploadCount),1)]),l("div",xe,[e[27]||(e[27]=l("span",{class:"label"},"下载资料数：",-1)),l("span",null,p(n.value.downloadCount),1)])])])]),_:1}),o(c,{class:"upload-history-card"},{header:s(()=>[...e[28]||(e[28]=[l("div",{class:"card-header"},[l("span",null,"上传历史")],-1)])]),default:s(()=>[o(E,{data:z.value,style:{width:"100%"}},{default:s(()=>[o(i,{prop:"name",label:"资料名称","min-width":"200"}),o(i,{prop:"categoryName",label:"分类",width:"100"}),o(i,{prop:"uploadTime",label:"上传时间",width:"180"},{default:s(r=>[v(p(D(r.row.uploadTime)),1)]),_:1}),o(i,{prop:"downloadCount",label:"下载次数",width:"100"}),o(i,{prop:"points",label:"获得积分",width:"100"})]),_:1},8,["data"]),l("div",$e,[o(J,{"current-page":k.value,"onUpdate:currentPage":e[0]||(e[0]=r=>k.value=r),"page-size":_.value,"onUpdate:pageSize":e[1]||(e[1]=r=>_.value=r),layout:"total, sizes, prev, pager, next, jumper",total:$.value,onSizeChange:oe,onCurrentChange:ae},null,8,["current-page","page-size","total"])])]),_:1}),o(c,{class:"download-history-card"},{header:s(()=>[...e[29]||(e[29]=[l("div",{class:"card-header"},[l("span",null,"下载历史")],-1)])]),default:s(()=>[o(E,{data:U.value,style:{width:"100%"}},{default:s(()=>[o(i,{prop:"name",label:"资料名称","min-width":"200"}),o(i,{prop:"categoryName",label:"分类",width:"100"}),o(i,{prop:"downloadTime",label:"下载时间",width:"180"},{default:s(r=>[v(p(D(r.row.downloadTime)),1)]),_:1}),o(i,{prop:"points",label:"消耗积分",width:"100"})]),_:1},8,["data"]),l("div",Re,[o(J,{"current-page":V.value,"onUpdate:currentPage":e[2]||(e[2]=r=>V.value=r),"page-size":_.value,"onUpdate:pageSize":e[3]||(e[3]=r=>_.value=r),layout:"total, sizes, prev, pager, next, jumper",total:R.value,onSizeChange:le,onCurrentChange:se},null,8,["current-page","page-size","total"])])]),_:1}),o(q,{modelValue:P.value,"onUpdate:modelValue":e[8]||(e[8]=r=>P.value=r),title:"修改密码",width:"400px"},{footer:s(()=>[l("span",De,[o(t,{onClick:e[7]||(e[7]=r=>P.value=!1)},{default:s(()=>[...e[30]||(e[30]=[v("取消",-1)])]),_:1}),o(t,{type:"primary",onClick:de},{default:s(()=>[...e[31]||(e[31]=[v("确定",-1)])]),_:1})])]),default:s(()=>[o(H,{model:g.value,rules:Q.value,ref_key:"passwordFormRef",ref:A},{default:s(()=>[o(C,{label:"原密码",prop:"oldPassword"},{default:s(()=>[o(S,{modelValue:g.value.oldPassword,"onUpdate:modelValue":e[4]||(e[4]=r=>g.value.oldPassword=r),type:"password",placeholder:"请输入原密码"},null,8,["modelValue"])]),_:1}),o(C,{label:"新密码",prop:"newPassword"},{default:s(()=>[o(S,{modelValue:g.value.newPassword,"onUpdate:modelValue":e[5]||(e[5]=r=>g.value.newPassword=r),type:"password",placeholder:"请输入新密码"},null,8,["modelValue"])]),_:1}),o(C,{label:"确认新密码",prop:"confirmPassword"},{default:s(()=>[o(S,{modelValue:g.value.confirmPassword,"onUpdate:modelValue":e[6]||(e[6]=r=>g.value.confirmPassword=r),type:"password",placeholder:"请确认新密码"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"]),o(c,{class:"password-history-card"},{header:s(()=>[...e[32]||(e[32]=[l("div",{class:"card-header"},[l("span",null,"最近修改密码记录")],-1)])]),default:s(()=>[b.value.length>0?(G(),ve(E,{key:0,data:b.value,style:{width:"100%"}},{default:s(()=>[o(i,{prop:"modifyTime",label:"修改时间",width:"200"},{default:s(r=>[v(p(D(r.row.modifyTime)),1)]),_:1}),o(i,{prop:"ipAddress",label:"修改IP","min-width":"150"}),o(i,{prop:"device",label:"设备信息","min-width":"300"})]),_:1},8,["data"])):(G(),L("div",Fe,[o(ie,{description:"暂无密码修改记录"})]))]),_:1}),o(q,{modelValue:N.value,"onUpdate:modelValue":e[11]||(e[11]=r=>N.value=r),title:"修改学院",width:"400px"},{footer:s(()=>[l("span",Be,[o(t,{onClick:e[10]||(e[10]=r=>N.value=!1)},{default:s(()=>[...e[33]||(e[33]=[v("取消",-1)])]),_:1}),o(t,{type:"primary",onClick:re},{default:s(()=>[...e[34]||(e[34]=[v("确定",-1)])]),_:1})])]),default:s(()=>[o(H,{model:h.value,rules:X.value,ref_key:"collegeFormRef",ref:T},{default:s(()=>[o(C,{label:"学院",prop:"college"},{default:s(()=>[o(S,{modelValue:h.value.college,"onUpdate:modelValue":e[9]||(e[9]=r=>h.value.college=r),placeholder:"请输入学院名称"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"]),o(q,{modelValue:j.value,"onUpdate:modelValue":e[15]||(e[15]=r=>j.value=r),title:"修改专业和年级",width:"400px"},{footer:s(()=>[l("span",Ee,[o(t,{onClick:e[14]||(e[14]=r=>j.value=!1)},{default:s(()=>[...e[35]||(e[35]=[v("取消",-1)])]),_:1}),o(t,{type:"primary",onClick:ne},{default:s(()=>[...e[36]||(e[36]=[v("确定",-1)])]),_:1})])]),default:s(()=>[o(H,{model:y.value,rules:Y.value,ref_key:"majorGradeFormRef",ref:x},{default:s(()=>[o(C,{label:"专业",prop:"major"},{default:s(()=>[o(S,{modelValue:y.value.major,"onUpdate:modelValue":e[12]||(e[12]=r=>y.value.major=r),placeholder:"请输入专业名称"},null,8,["modelValue"])]),_:1}),o(C,{label:"年级",prop:"grade"},{default:s(()=>[o(S,{modelValue:y.value.grade,"onUpdate:modelValue":e[13]||(e[13]=r=>y.value.grade=r),placeholder:"请输入年级，例如：2025"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])])}}},Le=we(He,[["__scopeId","data-v-4fa01232"]]);export{Le as default};

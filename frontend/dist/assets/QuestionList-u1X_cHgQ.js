import{o as X,c as $,b as i,w as u,E as _,e as f,f as y,u as Y,g as v,a as c,z as ee,l as C,N as te,h as S,v as I,d as oe,F as K,A,t as k,O as se,P as le,H as O,B,Q as ae,R as ne,S as U}from"./index-C2Rltc0A.js";import{a as x}from"./index-CzZzTWyT.js";import{_ as re}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ce={class:"question-list"},ie={class:"list-content"},ue={class:"search-sort-container"},de={class:"search-box"},_e={class:"sort-box"},ge={class:"filter-box"},pe={class:"question-items"},ve={class:"question-header"},me={class:"question-title"},fe={class:"question-meta"},he={class:"author"},ye={class:"time"},Se={class:"question-content"},ke={class:"question-footer"},Ce={class:"question-tags"},Ie={class:"question-stats"},qe={class:"stat-item"},we={class:"stat-item"},Te=["onClick"],$e=["onClick"],xe={key:2},be={key:3},ze={key:4},Qe={class:"pagination"},De={__name:"QuestionList",setup(Ve){const J=Y(),D=y(""),g=y("latest"),V=y(!1),q=y(1),w=y(10),b=y(0),T=y([]),p=y([]),d=y([]),h=async()=>{try{const a=await x.get("/question/list",{params:{page:q.value,size:w.value,orderBy:"latest",keyword:D.value,isAgri:V.value?1:0}});if(a.code===200){let e=a.data.list.map(o=>{const t=o.tags?o.tags.split(",").map(s=>s.trim()):[];return{...o,tags:t,createTime:new Date(o.createTime).toLocaleString(),commentCount:0,createTimeStamp:new Date(o.createTime).getTime()}});for(const o of e)try{const t=await x.get("/comment/list",{params:{relType:1,relId:o.id}});t.code===200&&Array.isArray(t.data)&&(o.commentCount=t.data.length)}catch(t){console.error(`获取问题 ${o.id} 的评论数量失败:`,t)}e=P(e,g.value),g.value==="collected"?(e=e.filter(o=>p.value.includes(o.id)),b.value=e.length):b.value=a.data.total,T.value=e,await E()}else _.error("获取问题列表失败")}catch(a){console.error("获取问题列表失败:",a),_.error("获取问题列表失败")}},P=(a,e)=>{const o=[...a];switch(e){case"latest":return o.sort((t,s)=>s.createTimeStamp-t.createTimeStamp);case"hottest":return o.sort((t,s)=>(s.viewCount||0)-(t.viewCount||0));case"featured":return o.sort((t,s)=>{const l=(s.likeCount||0)-(t.likeCount||0);return l!==0?l:s.createTimeStamp-t.createTimeStamp});default:return o}},E=async()=>{p.value=[],d.value=[];const a=localStorage.getItem("user");if(!a)return;const e=JSON.parse(a);for(const o of T.value)try{const t=String(o.id),s=`question_liked_${e.id}_${t}`,l=`question_collected_${e.id}_${t}`,r=localStorage.getItem(s)==="true",m=localStorage.getItem(l)==="true";r&&p.value.push(t),m&&d.value.push(t),console.log("初始化问题状态:",t,"isLiked:",r,"isCollected:",m)}catch(t){console.error("初始化行为状态失败:",t)}},M=a=>{a==="collected"?z():h()},R=a=>{w.value=a,g.value==="collected"?z():h()},F=a=>{q.value=a,g.value==="collected"?z():h()},z=async()=>{try{console.log("=== 开始加载收藏问题 ===");const a=localStorage.getItem("user");if(!a){_.error("请先登录"),g.value="latest";return}const e=JSON.parse(a);console.log("用户信息:",e),console.log("调用API获取收藏问题:",{userId:e.id,page:q.value,size:w.value});const o=await x.get("/question/collected",{params:{userId:e.id,page:q.value,size:w.value}});if(console.log("API返回结果:",o),o.code===200){console.log("收藏问题列表:",o.data.list),console.log("收藏问题总数:",o.data.total);let t=o.data.list.map(l=>{const r=l.tags?l.tags.split(",").map(m=>m.trim()):[];return{...l,tags:r,createTime:new Date(l.createTime).toLocaleString(),commentCount:0,createTimeStamp:new Date(l.createTime).getTime()}});console.log("处理后的问题列表:",t);for(const l of t)try{const r=await x.get("/comment/list",{params:{relType:1,relId:l.id}});r.code===200&&Array.isArray(r.data)&&(l.commentCount=r.data.length)}catch(r){console.error(`获取问题 ${l.id} 的评论数量失败:`,r)}t=t.sort((l,r)=>(r.collectCount||0)-(l.collectCount||0)),console.log("排序后的问题列表:",t),T.value=t,b.value=o.data.total,console.log("更新后questionData:",T.value),console.log("更新后total:",b.value);const s=JSON.parse(localStorage.getItem("user"));if(s){d.value=[];for(const l of t){const r=String(l.id);d.value.push(r);const m=`question_collected_${s.id}_${r}`;localStorage.setItem(m,"true")}console.log("收藏模式下的收藏状态:",d.value)}if(p.value=[],s)for(const l of t){const r=String(l.id),m=`question_liked_${s.id}_${r}`;localStorage.getItem(m)==="true"&&p.value.push(r)}console.log("=== 加载收藏问题结束 ===")}else console.error("获取收藏问题失败，响应码:",o.code),_.error("获取收藏问题失败"),g.value="latest"}catch(a){console.error("获取收藏问题失败:",a),_.error("获取收藏问题失败"),g.value="latest"}},j=a=>{J.push(`/question/${a}`)},H=async a=>{try{const e=localStorage.getItem("user");if(!e){_.error("请先登录");return}const o=JSON.parse(e),t=await x.post("/question/like",null,{params:{userId:o.id,questionId:a.id}});if(t.code===200){const s=String(a.id),l=`question_liked_${o.id}_${s}`;if(t.message==="取消点赞成功"){const r=p.value.indexOf(s);r>-1&&p.value.splice(r,1),localStorage.setItem(l,"false"),console.log("取消点赞，从数组中移除问题ID:",s),console.log("更新后likedQuestions数组:",p.value),_.success("取消点赞成功，扣除1积分")}else t.message==="点赞成功"&&(p.value.includes(s)||p.value.push(s),localStorage.setItem(l,"true"),console.log("点赞，向数组中添加问题ID:",s),console.log("更新后likedQuestions数组:",p.value),_.success("点赞成功，获得1积分"));await h()}else _.error(t.message)}catch(e){console.error("点赞失败:",e),_.error("点赞失败，请检查网络连接")}},Z=async a=>{try{const e=localStorage.getItem("user");if(!e){_.error("请先登录");return}const o=JSON.parse(e),t=await x.post("/question/collect",null,{params:{userId:o.id,questionId:a.id}});if(t.code===200){const s=String(a.id),l=`question_collected_${o.id}_${s}`;if(t.message==="取消收藏成功"){const r=d.value.indexOf(s);r>-1&&d.value.splice(r,1),localStorage.setItem(l,"false"),console.log("取消收藏，从数组中移除问题ID:",s),console.log("更新后collectedQuestions数组:",d.value),_.success("取消收藏成功，扣除2积分")}else t.message==="收藏成功"&&(d.value.includes(s)||d.value.push(s),localStorage.setItem(l,"true"),console.log("收藏，向数组中添加问题ID:",s),console.log("更新后collectedQuestions数组:",d.value),_.success("收藏成功，获得2积分"));g.value==="collected"?await z():await h()}else _.error(t.message)}catch(e){console.error("收藏失败:",e),_.error("收藏失败，请检查网络连接")}};return X(()=>{h()}),(a,e)=>{const o=f("el-icon"),t=f("el-button"),s=f("el-input"),l=f("el-radio-button"),r=f("el-radio-group"),m=f("el-checkbox"),L=f("el-empty"),G=f("el-tag"),N=f("el-card"),W=f("el-pagination");return v(),$("div",ce,[i(N,{class:"list-card"},{header:u(()=>[...e[6]||(e[6]=[c("div",{class:"card-header"},[c("span",null,"问题列表")],-1)])]),default:u(()=>[c("div",ie,[c("div",ue,[c("div",de,[i(s,{modelValue:D.value,"onUpdate:modelValue":e[0]||(e[0]=n=>D.value=n),placeholder:"请输入关键词搜索问题",style:{width:"300px"},clearable:"",onKeyup:ee(h,["enter"])},{append:u(()=>[i(t,{onClick:h},{default:u(()=>[i(o,null,{default:u(()=>[i(C(te))]),_:1})]),_:1})]),_:1},8,["modelValue"])]),c("div",_e,[i(r,{modelValue:g.value,"onUpdate:modelValue":e[1]||(e[1]=n=>g.value=n),onChange:M},{default:u(()=>[i(l,{label:"latest"},{default:u(()=>[...e[7]||(e[7]=[S("最新",-1)])]),_:1}),i(l,{label:"hottest"},{default:u(()=>[...e[8]||(e[8]=[S("最热",-1)])]),_:1}),i(l,{label:"featured"},{default:u(()=>[...e[9]||(e[9]=[S("精选",-1)])]),_:1}),i(l,{label:"collected"},{default:u(()=>[...e[10]||(e[10]=[S("收藏",-1)])]),_:1})]),_:1},8,["modelValue"])]),c("div",ge,[i(m,{modelValue:V.value,"onUpdate:modelValue":e[2]||(e[2]=n=>V.value=n),onChange:e[3]||(e[3]=n=>g.value==="collected"?z():h())},{default:u(()=>[...e[11]||(e[11]=[S("期末专区",-1)])]),_:1},8,["modelValue"])])]),c("div",pe,[T.value.length===0?(v(),I(L,{key:0,description:"暂无问题"})):oe("",!0),(v(!0),$(K,null,A(T.value,n=>(v(),I(N,{key:n.id,class:"question-item",onClick:Q=>j(n.id)},{default:u(()=>[c("div",ve,[c("h3",me,k(n.title),1),c("div",fe,[c("span",he,k(n.author),1),c("span",ye,k(n.createTime),1)])]),c("div",Se,k(n.content),1),c("div",ke,[c("div",Ce,[(v(!0),$(K,null,A(n.tags,Q=>(v(),I(G,{key:Q,size:"small"},{default:u(()=>[S(k(Q),1)]),_:2},1024))),128))]),c("div",Ie,[c("span",qe,[i(o,null,{default:u(()=>[i(C(se))]),_:1}),S(" "+k(n.viewCount),1)]),c("span",we,[i(o,null,{default:u(()=>[i(C(le))]),_:1}),S(" "+k(n.commentCount),1)]),c("span",{class:B(["stat-item like-btn",{liked:p.value.includes(String(n.id))}]),onClick:O(Q=>H(n),["stop"])},[p.value.includes(String(n.id))?(v(),I(o,{key:0},{default:u(()=>[i(C(ae))]),_:1})):(v(),I(o,{key:1},{default:u(()=>[i(C(ne))]),_:1})),S(" "+k(Math.max(0,n.likeCount||0)),1)],10,Te),c("span",{class:B(["stat-item collect-btn",{collected:d.value.includes(String(n.id))}]),onClick:O(Q=>Z(n),["stop"])},[d.value.includes(String(n.id))?(v(),I(o,{key:0},{default:u(()=>[i(C(U))]),_:1})):(v(),I(o,{key:1},{default:u(()=>[i(C(U))]),_:1})),g.value==="collected"&&d.value.includes(String(n.id))?(v(),$("span",xe,"已收藏")):g.value==="collected"&&!d.value.includes(String(n.id))?(v(),$("span",be,"未收藏")):(v(),$("span",ze,k(n.collectCount||0),1))],10,$e)])])]),_:2},1032,["onClick"]))),128))]),c("div",Qe,[i(W,{"current-page":q.value,"onUpdate:currentPage":e[4]||(e[4]=n=>q.value=n),"page-size":w.value,"onUpdate:pageSize":e[5]||(e[5]=n=>w.value=n),"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",total:b.value,onSizeChange:R,onCurrentChange:F},null,8,["current-page","page-size","total"])])])]),_:1})])}}},Ae=re(De,[["__scopeId","data-v-24b31a66"]]);export{Ae as default};

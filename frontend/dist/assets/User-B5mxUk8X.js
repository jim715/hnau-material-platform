import{o as re,L as ne,c as de,b as a,w as t,e as v,f as u,u as ue,k as ie,g as pe,a as o,t as c,h as f,j as ce,E as m}from"./index-C2Rltc0A.js";import{a as y}from"./index-CzZzTWyT.js";import{_ as ge}from"./_plugin-vue_export-helper-DlAUqK2U.js";const me={class:"user-container"},ve={class:"card-header"},fe={class:"user-info"},we={class:"avatar-section"},ye={style:{display:"inline-block",padding:"10px"}},_e={class:"avatar-text"},be={class:"info-content"},Ce={class:"info-item"},Se={class:"info-item"},Pe={class:"info-item"},Ve={class:"info-item"},ke={class:"info-item"},he={class:"info-item"},je={class:"info-item"},Ie={class:"points"},ze={class:"info-item"},Ue={class:"info-item"},Ne={class:"pagination-container"},xe={class:"pagination-container"},Te={class:"dialog-footer"},Ae={class:"dialog-footer"},Re={class:"dialog-footer"},M="https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=default%20user%20avatar%20simple%20gray%20portrait&image_size=square",$e={__name:"User",setup(De){const h=ue(),J=ie(),r=u({studentId:"",name:"",college:"",major:"",grade:"",className:"",points:0,uploadCount:0,downloadCount:0,avatar:""}),L=ce(()=>{const l=r.value.major||"未设置",e=r.value.grade||"",n=e?`${e.slice(-2)}级`:"未设置",i=`${r.value.className||"未设置"}班`,p=r.value.name||"未设置";return`${l}${n}${i}${p}`}),S=u(!1),g=u({oldPassword:"",newPassword:"",confirmPassword:""}),N=u(null),O=u({oldPassword:[{required:!0,message:"请输入原密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"新密码长度至少为6位",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:(l,e,n)=>{e!==g.value.newPassword?n(new Error("两次输入的密码不一致")):n()},trigger:"blur"}]}),j=u(!1),P=u({college:""}),x=u(null),W=u({college:[{required:!0,message:"请输入学院名称",trigger:"blur"}]}),I=u(!1),w=u({major:"",grade:""}),T=u(null),K=u({major:[{required:!0,message:"请输入专业名称",trigger:"blur"}],grade:[{required:!0,message:"请输入年级",trigger:"blur"}]}),z=u([]),U=u([]),V=u(1),k=u(1),_=u(10),A=u(0),R=u(0),q=l=>l?new Date(l).toLocaleString():"",Q=async()=>{try{const l=typeof localStorage<"u"?localStorage.getItem("token"):"";if(!l){h.push("/login");return}r.value={studentId:"",name:"",major:"",grade:"",college:"",className:"",points:0,uploadCount:0,downloadCount:0,avatar:""},console.log("开始获取用户信息，token:",l);try{const e={headers:{Authorization:`Bearer ${l}`}},n=await y.get("/user/info",e);if(console.log("获取用户信息成功，响应:",n),n.data){console.log("用户信息:",n.data),r.value=n.data,console.log("使用API返回的用户信息:",r.value),n.data.downloadCount!==void 0&&(r.value.downloadCount=n.data.downloadCount);try{const d=await y.get("/integral/user",e);console.log("获取积分信息成功:",d),d.data&&(r.value.points=d.data.totalPoints||r.value.points,r.value.uploadCount=d.data.uploadCount||0,console.log("已更新积分:",r.value.points),console.log("已更新上传次数:",r.value.uploadCount))}catch(d){console.error("获取积分信息失败:",d)}typeof localStorage<"u"&&(localStorage.setItem("user",JSON.stringify(r.value)),console.log("已更新localStorage中的用户信息"))}}catch(e){console.error("API调用失败:",e),typeof localStorage<"u"&&localStorage.removeItem("user")}}catch(l){console.error("获取用户信息失败:",l),h.push("/login")}},$=async()=>{try{const l=typeof localStorage<"u"?localStorage.getItem("token"):"";console.log("获取上传历史，token:",l);const e={page:V.value,pageSize:_.value};console.log("获取上传历史，参数:",e);const n={headers:{Authorization:`Bearer ${l}`}};console.log("获取上传历史，配置:",n),console.log("开始调用API...");const d=await y.get("/user/uploadHistory",{params:e});console.log("获取上传历史成功:",d),console.log("资料列表:",d.data.list),console.log("资料总数:",d.data.total),d.data&&d.data.list&&Array.isArray(d.data.list)?(d.data.list.forEach((i,p)=>{console.log(`资料${p+1}:`,i),console.log(`资料${p+1}分类名称:`,i.categoryName)}),z.value=d.data.list.map(i=>({id:i.id,name:i.name,categoryName:i.categoryName||"未分类",uploadTime:i.createTime,downloadCount:i.downloadCount,points:i.points||20})),A.value=d.data.total):(console.error("获取上传历史失败: response.data.list 不存在或不是数组"),z.value=[],A.value=0),console.log("上传历史数据处理完成:",z.value)}catch(l){console.error("获取上传历史失败:",l)}},D=async()=>{try{const l=typeof localStorage<"u"?localStorage.getItem("token"):"";console.log("获取下载历史，token:",l);const e={page:k.value,pageSize:_.value};console.log("获取下载历史，参数:",e);const n={headers:{Authorization:`Bearer ${l}`}};console.log("获取下载历史，配置:",n),console.log("开始调用API...");const d=await y.get("/user/downloadHistory",{params:e});console.log("获取下载历史成功:",d),console.log("下载历史列表:",d.data.list),console.log("下载历史总数:",d.data.total),d.data&&d.data.list&&Array.isArray(d.data.list)?(U.value=d.data.list,R.value=d.data.total):(console.error("获取下载历史失败: response.data.list 不存在或不是数组"),U.value=[],R.value=0),console.log("下载历史数据处理完成:",U.value)}catch(l){console.error("获取下载历史失败:",l)}},X=l=>{_.value=l,V.value=1,$()},Y=l=>{V.value=l,$()},Z=l=>{_.value=l,k.value=1,D()},ee=l=>{k.value=l,D()},oe=()=>{S.value=!0},ae=async()=>{x.value&&await x.value.validate(async l=>{if(l)try{const e=await y.post("/user/updateCollege",{college:P.value.college});e.code===200?(r.value.college=P.value.college,typeof localStorage<"u"&&localStorage.setItem("user",JSON.stringify(r.value)),m.success("学院修改成功!"),j.value=!1):m.error(e.message||"学院修改失败!")}catch(e){console.error("学院修改失败:",e),m.error("学院修改失败!")}})},le=async()=>{T.value&&await T.value.validate(async l=>{if(l)try{const e=await y.post("/user/updateMajorGrade",{major:w.value.major,grade:w.value.grade});e.code===200?(r.value.major=w.value.major,r.value.grade=w.value.grade,typeof localStorage<"u"&&localStorage.setItem("user",JSON.stringify(r.value)),m.success("专业和年级修改成功!"),I.value=!1):m.error(e.message||"专业和年级修改失败!")}catch(e){console.error("专业和年级修改失败:",e),m.error("专业和年级修改失败!")}})},te=async()=>{N.value&&await N.value.validate(async l=>{if(l)try{const e=await y.post("/user/updatePwd",{oldPassword:g.value.oldPassword,newPassword:g.value.newPassword});e.code===200?(m.success("密码修改成功!"),S.value=!1,g.value={oldPassword:"",newPassword:"",confirmPassword:""}):m.error(e.message||"密码修改失败!")}catch(e){console.error("密码修改失败:",e),m.error("密码修改失败!")}})},se=async()=>{try{console.log("开始退出登录..."),console.log("localStorage中的token:",localStorage.getItem("token")),console.log("localStorage中的user:",localStorage.getItem("user"));const l=await y.post("/user/logout");if(console.log("退出登录响应:",l),J.path.startsWith("/admin"))try{console.log("当前在Admin页面，强制触发登录记录刷新...");const e=await y.get("/admin/login/records",{params:{page:1,pageSize:10}});console.log("强制刷新登录记录成功:",e),await new Promise(n=>setTimeout(n,2500))}catch(e){console.error("强制刷新登录记录失败:",e),await new Promise(n=>setTimeout(n,1500))}else await new Promise(e=>setTimeout(e,500));localStorage.removeItem("user"),localStorage.removeItem("token"),m.success("退出登录成功"),h.push("/login")}catch(l){console.error("退出登录失败:",l),console.error("错误详情:",l.response),console.error("错误消息:",l.message),localStorage.removeItem("user"),localStorage.removeItem("token"),m.success("退出登录成功"),h.push("/login")}};re(()=>{G()}),ne(()=>{G()});const G=async()=>{await Q(),await $(),await D()};return(l,e)=>{const n=v("el-button"),d=v("el-avatar"),i=v("el-card"),p=v("el-table-column"),B=v("el-table"),H=v("el-pagination"),b=v("el-input"),C=v("el-form-item"),F=v("el-form"),E=v("el-dialog");return pe(),de("div",me,[a(i,{class:"user-info-card"},{header:t(()=>[o("div",ve,[e[17]||(e[17]=o("span",null,"用户信息",-1)),a(n,{type:"primary",onClick:oe},{default:t(()=>[...e[16]||(e[16]=[f("修改密码",-1)])]),_:1})])]),default:t(()=>[o("div",fe,[o("div",we,[o("div",ye,[a(d,{size:120,src:M},{default:t(()=>[o("img",{src:M,alt:"头像"})]),_:1}),o("div",_e,c(L.value),1),a(n,{type:"default",onClick:se,style:{"margin-top":"10px"}},{default:t(()=>[...e[18]||(e[18]=[f(" 账户切换 ",-1)])]),_:1})])]),o("div",be,[o("div",Ce,[e[19]||(e[19]=o("span",{class:"label"},"学号：",-1)),o("span",null,c(r.value.studentId),1)]),o("div",Se,[e[20]||(e[20]=o("span",{class:"label"},"姓名：",-1)),o("span",null,c(r.value.name),1)]),o("div",Pe,[e[21]||(e[21]=o("span",{class:"label"},"学院：",-1)),o("span",null,c(r.value.college||"未设置"),1)]),o("div",Ve,[e[22]||(e[22]=o("span",{class:"label"},"专业：",-1)),o("span",null,c(r.value.major||"未设置"),1)]),o("div",ke,[e[23]||(e[23]=o("span",{class:"label"},"年级：",-1)),o("span",null,c(r.value.grade||"未设置"),1)]),o("div",he,[e[24]||(e[24]=o("span",{class:"label"},"班级：",-1)),o("span",null,c(r.value.className||"未设置"),1)]),o("div",je,[e[25]||(e[25]=o("span",{class:"label"},"积分：",-1)),o("span",Ie,c(r.value.points),1)]),o("div",ze,[e[26]||(e[26]=o("span",{class:"label"},"上传资料数：",-1)),o("span",null,c(r.value.uploadCount),1)]),o("div",Ue,[e[27]||(e[27]=o("span",{class:"label"},"下载资料数：",-1)),o("span",null,c(r.value.downloadCount),1)])])])]),_:1}),a(i,{class:"upload-history-card"},{header:t(()=>[...e[28]||(e[28]=[o("div",{class:"card-header"},[o("span",null,"上传历史")],-1)])]),default:t(()=>[a(B,{data:z.value,style:{width:"100%"}},{default:t(()=>[a(p,{prop:"name",label:"资料名称","min-width":"200"}),a(p,{prop:"categoryName",label:"分类",width:"100"}),a(p,{prop:"uploadTime",label:"上传时间",width:"180"},{default:t(s=>[f(c(q(s.row.uploadTime)),1)]),_:1}),a(p,{prop:"downloadCount",label:"下载次数",width:"100"}),a(p,{prop:"points",label:"获得积分",width:"100"})]),_:1},8,["data"]),o("div",Ne,[a(H,{"current-page":V.value,"onUpdate:currentPage":e[0]||(e[0]=s=>V.value=s),"page-size":_.value,"onUpdate:pageSize":e[1]||(e[1]=s=>_.value=s),layout:"total, sizes, prev, pager, next, jumper",total:A.value,onSizeChange:X,onCurrentChange:Y},null,8,["current-page","page-size","total"])])]),_:1}),a(i,{class:"download-history-card"},{header:t(()=>[...e[29]||(e[29]=[o("div",{class:"card-header"},[o("span",null,"下载历史")],-1)])]),default:t(()=>[a(B,{data:U.value,style:{width:"100%"}},{default:t(()=>[a(p,{prop:"name",label:"资料名称","min-width":"200"}),a(p,{prop:"categoryName",label:"分类",width:"100"}),a(p,{prop:"downloadTime",label:"下载时间",width:"180"},{default:t(s=>[f(c(q(s.row.downloadTime)),1)]),_:1}),a(p,{prop:"points",label:"消耗积分",width:"100"})]),_:1},8,["data"]),o("div",xe,[a(H,{"current-page":k.value,"onUpdate:currentPage":e[2]||(e[2]=s=>k.value=s),"page-size":_.value,"onUpdate:pageSize":e[3]||(e[3]=s=>_.value=s),layout:"total, sizes, prev, pager, next, jumper",total:R.value,onSizeChange:Z,onCurrentChange:ee},null,8,["current-page","page-size","total"])])]),_:1}),a(E,{modelValue:S.value,"onUpdate:modelValue":e[8]||(e[8]=s=>S.value=s),title:"修改密码",width:"400px"},{footer:t(()=>[o("span",Te,[a(n,{onClick:e[7]||(e[7]=s=>S.value=!1)},{default:t(()=>[...e[30]||(e[30]=[f("取消",-1)])]),_:1}),a(n,{type:"primary",onClick:te},{default:t(()=>[...e[31]||(e[31]=[f("确定",-1)])]),_:1})])]),default:t(()=>[a(F,{model:g.value,rules:O.value,ref_key:"passwordFormRef",ref:N},{default:t(()=>[a(C,{label:"原密码",prop:"oldPassword"},{default:t(()=>[a(b,{modelValue:g.value.oldPassword,"onUpdate:modelValue":e[4]||(e[4]=s=>g.value.oldPassword=s),type:"password",placeholder:"请输入原密码"},null,8,["modelValue"])]),_:1}),a(C,{label:"新密码",prop:"newPassword"},{default:t(()=>[a(b,{modelValue:g.value.newPassword,"onUpdate:modelValue":e[5]||(e[5]=s=>g.value.newPassword=s),type:"password",placeholder:"请输入新密码"},null,8,["modelValue"])]),_:1}),a(C,{label:"确认新密码",prop:"confirmPassword"},{default:t(()=>[a(b,{modelValue:g.value.confirmPassword,"onUpdate:modelValue":e[6]||(e[6]=s=>g.value.confirmPassword=s),type:"password",placeholder:"请确认新密码"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"]),a(E,{modelValue:j.value,"onUpdate:modelValue":e[11]||(e[11]=s=>j.value=s),title:"修改学院",width:"400px"},{footer:t(()=>[o("span",Ae,[a(n,{onClick:e[10]||(e[10]=s=>j.value=!1)},{default:t(()=>[...e[32]||(e[32]=[f("取消",-1)])]),_:1}),a(n,{type:"primary",onClick:ae},{default:t(()=>[...e[33]||(e[33]=[f("确定",-1)])]),_:1})])]),default:t(()=>[a(F,{model:P.value,rules:W.value,ref_key:"collegeFormRef",ref:x},{default:t(()=>[a(C,{label:"学院",prop:"college"},{default:t(()=>[a(b,{modelValue:P.value.college,"onUpdate:modelValue":e[9]||(e[9]=s=>P.value.college=s),placeholder:"请输入学院名称"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"]),a(E,{modelValue:I.value,"onUpdate:modelValue":e[15]||(e[15]=s=>I.value=s),title:"修改专业和年级",width:"400px"},{footer:t(()=>[o("span",Re,[a(n,{onClick:e[14]||(e[14]=s=>I.value=!1)},{default:t(()=>[...e[34]||(e[34]=[f("取消",-1)])]),_:1}),a(n,{type:"primary",onClick:le},{default:t(()=>[...e[35]||(e[35]=[f("确定",-1)])]),_:1})])]),default:t(()=>[a(F,{model:w.value,rules:K.value,ref_key:"majorGradeFormRef",ref:T},{default:t(()=>[a(C,{label:"专业",prop:"major"},{default:t(()=>[a(b,{modelValue:w.value.major,"onUpdate:modelValue":e[12]||(e[12]=s=>w.value.major=s),placeholder:"请输入专业名称"},null,8,["modelValue"])]),_:1}),a(C,{label:"年级",prop:"grade"},{default:t(()=>[a(b,{modelValue:w.value.grade,"onUpdate:modelValue":e[13]||(e[13]=s=>w.value.grade=s),placeholder:"请输入年级，例如：2025"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])])}}},Ge=ge($e,[["__scopeId","data-v-05c2b82c"]]);export{Ge as default};

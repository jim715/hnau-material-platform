import{o as pe,c as b,b as o,w as l,E as w,e as d,f as u,u as me,y as ve,g as p,z as ge,h as m,a as c,F as E,A as R,B as fe,t as h,v as S,l as j,C as _e,D as he,d as A,G as ye,H as we,I as Ce}from"./index-C2Rltc0A.js";import{a as F}from"./index-CzZzTWyT.js";import{_ as ke}from"./_plugin-vue_export-helper-DlAUqK2U.js";const be={class:"home-container"},Te={class:"card-header"},ze={class:"category-section"},Ne={class:"category-grid"},Be={key:0,class:"sub-category-container"},Se={class:"material-section"},Ve={key:0,class:"no-data"},xe=["onClick"],$e={key:2,class:"pagination-container"},Ie={class:"material-detail"},Me={class:"detail-header"},De={class:"detail-content"},Ue={class:"detail-tags"},Ee={class:"detail-actions"},Fe={__name:"Home",setup(Le){const Q=me(),L=u(""),$=u([]),W=u([]),z=u([]),H=u([]),I=u(0),V=u(""),K=u("uploadTime"),C=u(1),M=u(10),P=u(0),D=u(!1),U=u(!1),y=u({}),G=t=>t?new Date(t).toLocaleString():"",X=t=>{if(!t)return"0 B";const e=1024,n=["B","KB","MB","GB","TB"],s=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,s)).toFixed(2))+" "+n[s]},Y=async()=>{try{const t=await F.get("/category/tree");t.code===200?$.value=t.data:w.error("获取分类失败")}catch(t){console.error("获取分类失败:",t),w.error("获取分类失败，请检查网络连接")}},Z=async()=>{try{const t=await F.get("/tag/tree");if(t.code===200){const e=n=>{let s=[];for(const r of n)s.push(r),r.children&&r.children.length>0&&(s=s.concat(e(r.children)));return s};W.value=e(t.data)}else w.error("获取标签失败")}catch(t){console.error("获取标签失败:",t),w.error("获取标签失败，请检查网络连接")}},T=async()=>{D.value=!0;try{const t={page:C.value,pageSize:M.value,categoryId:I.value||void 0,keyword:L.value||void 0,tag:V.value||void 0,sortBy:K.value},e=await F.get("/material/list",{params:t});e.code===200?(H.value=e.data.list.map(n=>{let s="未分类";const r=(_,v)=>{for(const i of _){if(i.id===v)return i.name;if(i.children&&i.children.length>0){const g=r(i.children,v);if(g)return g}}return null},f=r($.value,n.categoryId);return f&&(s=f),{...n,uploadTime:n.createTime,categoryName:s}}),P.value=e.data.total):w.error(e.message)}catch(t){console.error("获取资料列表失败:",t),w.error("获取资料列表失败，请检查网络连接")}finally{D.value=!1}},O=()=>{C.value=1,T()},J=t=>{I.value=t,V.value="",C.value=1,T()},ee=t=>{V.value=t,C.value=1,T(),U.value=!1},te=t=>{const e=z.value.indexOf(t);e>-1?z.value.splice(e,1):z.value.push(t)},ae=()=>{C.value=1,T()},oe=t=>{M.value=t,C.value=1,T()},le=t=>{C.value=t,T()},ne=async t=>{try{const e=await F.get(`/material/info/${t.id}`);if(e.code===200){const n=e.data;let s="未分类";const r=(_,v)=>{for(const i of _){if(i.id===v)return i.name;if(i.children&&i.children.length>0){const g=r(i.children,v);if(g)return g}}return null},f=r($.value,n.categoryId);f&&(s=f),y.value={...n,uploadTime:n.createTime,categoryName:s,uploader:n.username||"未知用户",tags:n.tags||[]},U.value=!0}else w.error("获取资料详情失败")}catch(e){console.error("获取资料详情失败:",e),w.error("获取资料详情失败，请检查网络连接")}},q=async t=>{console.log("开始下载资料:",t);const e=localStorage.getItem("user");if(!e){w.error("请先登录"),Q.push("/login");return}try{const s=JSON.parse(e).id,r=localStorage.getItem("token");console.log("用户ID:",s),console.log("认证 token:",r);const f=`http://localhost:8082/api/material/download/${t.id}`;console.log("下载API URL:",f);const _=await fetch(`${f}?userId=${s}`,{method:"GET",headers:{Authorization:`Bearer ${r}`}});if(console.log("响应状态:",_.status),console.log("响应状态文本:",_.statusText),!_.ok){const x=await _.json().catch(()=>null);throw x&&x.message?new Error(x.message):new Error(`HTTP error! status: ${_.status}`)}const v=await _.blob();console.log("获取到的blob:",v);const i=window.URL.createObjectURL(v),g=document.createElement("a");g.href=i,g.download=t.fileName||t.name,document.body.appendChild(g),g.click(),document.body.removeChild(g),w.success("下载成功")}catch(n){console.error("下载资料失败:",n),w.error(n.message||"下载失败，请检查网络连接")}};return pe(()=>{Y(),Z(),T()}),(t,e)=>{const n=d("el-button"),s=d("el-input"),r=d("el-card"),f=d("el-option"),_=d("el-select"),v=d("el-tag"),i=d("el-icon"),g=d("el-divider"),x=d("el-empty"),N=d("el-table-column"),se=d("el-table"),re=d("el-pagination"),B=d("el-descriptions-item"),ie=d("el-descriptions"),ce=d("el-dialog"),de=ve("loading");return p(),b("div",be,[o(r,{class:"search-card"},{default:l(()=>[o(s,{modelValue:L.value,"onUpdate:modelValue":e[0]||(e[0]=a=>L.value=a),placeholder:"搜索资料",clearable:"","suffix-icon":"el-icon-search",onKeyup:ge(O,["enter"])},{append:l(()=>[o(n,{type:"primary",onClick:O},{default:l(()=>[...e[7]||(e[7]=[m("搜索",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),o(r,{class:"combined-card"},{header:l(()=>[c("div",Te,[e[8]||(e[8]=c("span",null,"资料分类与列表",-1)),o(_,{modelValue:K.value,"onUpdate:modelValue":e[1]||(e[1]=a=>K.value=a),onChange:ae},{default:l(()=>[o(f,{label:"最新上传",value:"uploadTime"}),o(f,{label:"最多下载",value:"downloadCount"}),o(f,{label:"最多浏览",value:"viewCount"})]),_:1},8,["modelValue"])])]),default:l(()=>[c("div",ze,[e[10]||(e[10]=c("div",{class:"category-header"},[c("h3",null,"资料分类")],-1)),c("div",Ne,[o(v,{onClick:e[2]||(e[2]=a=>J(0)),effect:I.value===0&&!V.value?"dark":"plain",class:"category-tag main-category"},{default:l(()=>[...e[9]||(e[9]=[m(" 全部 ",-1)])]),_:1},8,["effect"]),(p(!0),b(E,null,R($.value,a=>(p(),b(E,{key:a.id},[o(v,{onClick:k=>te(a.name),class:fe(["category-tag main-category",{expanded:z.value.includes(a.name)}])},{default:l(()=>[m(h(a.name)+" ",1),a.children&&a.children.length>0?(p(),S(i,{key:0},{default:l(()=>[z.value.includes(a.name)?(p(),S(j(_e),{key:0})):(p(),S(j(he),{key:1}))]),_:2},1024)):A("",!0)]),_:2},1032,["onClick","class"]),z.value.includes(a.name)&&a.children&&a.children.length>0?(p(),b("div",Be,[(p(!0),b(E,null,R(a.children,k=>(p(),S(v,{key:k.id,onClick:ue=>J(k.id),effect:I.value===k.id&&!V.value?"dark":"plain",class:"category-tag sub-category"},{default:l(()=>[m(h(k.name),1)]),_:2},1032,["onClick","effect"]))),128))])):A("",!0)],64))),128))])]),o(g),c("div",Se,[H.value.length===0&&!D.value?(p(),b("div",Ve,[o(x,{description:"暂无资料"})])):ye((p(),S(se,{key:1,data:H.value,style:{width:"100%"}},{default:l(()=>[o(N,{prop:"name",label:"资料名称","min-width":"300"},{default:l(a=>[c("a",{href:"#",onClick:we(k=>ne(a.row),["prevent"])},h(a.row.name),9,xe)]),_:1}),o(N,{prop:"categoryName",label:"分类",width:"120"}),o(N,{prop:"uploadTime",label:"上传时间",width:"180"},{default:l(a=>[m(h(G(a.row.uploadTime)),1)]),_:1}),o(N,{prop:"viewCount",label:"浏览",width:"80"}),o(N,{prop:"downloadCount",label:"下载",width:"80"}),o(N,{label:"操作",width:"120"},{default:l(a=>[o(n,{type:"primary",size:"small",onClick:k=>q(a.row)},{default:l(()=>[...e[11]||(e[11]=[m(" 下载 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[de,D.value]]),P.value>0?(p(),b("div",$e,[o(re,{"current-page":C.value,"onUpdate:currentPage":e[3]||(e[3]=a=>C.value=a),"page-size":M.value,"onUpdate:pageSize":e[4]||(e[4]=a=>M.value=a),"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",total:P.value,onSizeChange:oe,onCurrentChange:le},null,8,["current-page","page-size","total"])])):A("",!0)])]),_:1}),o(ce,{modelValue:U.value,"onUpdate:modelValue":e[6]||(e[6]=a=>U.value=a),title:y.value.name,width:"80%","destroy-on-close":""},{default:l(()=>[c("div",Ie,[c("div",Me,[o(ie,{column:2,border:""},{default:l(()=>[o(B,{label:"上传者"},{default:l(()=>[m(h(y.value.uploader||"未知"),1)]),_:1}),o(B,{label:"上传时间"},{default:l(()=>[m(h(G(y.value.uploadTime)),1)]),_:1}),o(B,{label:"分类"},{default:l(()=>[m(h(y.value.categoryName),1)]),_:1}),o(B,{label:"浏览次数"},{default:l(()=>[m(h(y.value.viewCount)+"次",1)]),_:1}),o(B,{label:"下载次数"},{default:l(()=>[m(h(y.value.downloadCount)+"次",1)]),_:1}),o(B,{label:"文件大小"},{default:l(()=>[m(h(X(y.value.fileSize)),1)]),_:1})]),_:1})]),c("div",De,[e[12]||(e[12]=c("h3",null,"资料介绍",-1)),c("p",null,h(y.value.description),1)]),c("div",Ue,[e[13]||(e[13]=c("h3",null,"标签",-1)),(p(!0),b(E,null,R(y.value.tags,(a,k)=>(p(),S(v,{key:k,size:"small",class:"detail-tag",onClick:ue=>ee(a)},{default:l(()=>[m(h(a),1)]),_:2},1032,["onClick"]))),128))]),c("div",Ee,[o(n,{type:"primary",size:"large",onClick:e[5]||(e[5]=a=>q(y.value))},{default:l(()=>[o(i,null,{default:l(()=>[o(j(Ce))]),_:1}),e[14]||(e[14]=m(" 下载资料 ",-1))]),_:1})])])]),_:1},8,["modelValue","title"])])}}},Re=ke(Fe,[["__scopeId","data-v-d0cde3dc"]]);export{Re as default};

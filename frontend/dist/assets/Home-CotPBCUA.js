import{o as pe,c as b,b as o,w as l,E as w,e as u,f as p,u as me,y as ve,g as d,z as ge,h as m,a as s,F as R,A as j,B as Q,d as E,t as h,v as B,l as A,C as _e,D as fe,G as he,H as ye,I as we}from"./index-2wzUmdul.js";import{a as F}from"./index-CJj_0Lla.js";import{_ as ke}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ce={class:"home-container"},be={class:"card-header"},Te={class:"layout-container"},ze={class:"category-section"},Ne={class:"category-roadmap"},xe={class:"roadmap-item"},Be=["onClick"],Se={key:0,class:"roadmap-line"},Ve={class:"parent-category-wrapper"},$e={key:0,class:"sub-category-popup"},Ie={class:"popup-content"},Me={class:"material-section"},De={key:0,class:"no-data"},Ue=["onClick"],Ee={key:2,class:"pagination-container"},Fe={class:"material-detail"},Le={class:"detail-header"},He={class:"detail-content"},Ke={class:"detail-tags"},Pe={class:"detail-actions"},Re={__name:"Home",setup(je){const W=me(),L=p(""),S=p([]),X=p([]),T=p([]),H=p([]),I=p(0),V=p(""),K=p("uploadTime"),C=p(1),M=p(10),P=p(0),D=p(!1),U=p(!1),y=p({}),G=t=>t?new Date(t).toLocaleString():"",Y=t=>{if(!t)return"0 B";const e=1024,n=["B","KB","MB","GB","TB"],r=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,r)).toFixed(2))+" "+n[r]},Z=async()=>{try{const t=await F.get("/category/tree");t.code===200?S.value=t.data:w.error("获取分类失败")}catch(t){console.error("获取分类失败:",t),w.error("获取分类失败，请检查网络连接")}},ee=async()=>{try{const t=await F.get("/tag/tree");if(t.code===200){const e=n=>{let r=[];for(const i of n)r.push(i),i.children&&i.children.length>0&&(r=r.concat(e(i.children)));return r};X.value=e(t.data)}else w.error("获取标签失败")}catch(t){console.error("获取标签失败:",t),w.error("获取标签失败，请检查网络连接")}},z=async()=>{D.value=!0;try{const t={page:C.value,pageSize:M.value,categoryId:I.value||void 0,keyword:L.value||void 0,tag:V.value||void 0,sortBy:K.value},e=await F.get("/material/list",{params:t});e.code===200?(H.value=e.data.list.map(n=>{let r="未分类";const i=(f,v)=>{for(const c of f){if(c.id===v)return c.name;if(c.children&&c.children.length>0){const g=i(c.children,v);if(g)return g}}return null},_=i(S.value,n.categoryId);return _&&(r=_),{...n,uploadTime:n.createTime,categoryName:r}}),P.value=e.data.total):w.error(e.message)}catch(t){console.error("获取资料列表失败:",t),w.error("获取资料列表失败，请检查网络连接")}finally{D.value=!1}},O=()=>{C.value=1,z()},J=t=>{I.value=t,V.value="",C.value=1,z()},te=t=>{V.value=t,C.value=1,z(),U.value=!1},ae=t=>{const e=T.value.indexOf(t);e>-1?T.value.splice(e,1):T.value.push(t)},oe=()=>{C.value=1,z()},le=t=>{M.value=t,C.value=1,z()},ne=t=>{C.value=t,z()},se=async t=>{try{const e=await F.get(`/material/info/${t.id}`);if(e.code===200){const n=e.data;let r="未分类";const i=(f,v)=>{for(const c of f){if(c.id===v)return c.name;if(c.children&&c.children.length>0){const g=i(c.children,v);if(g)return g}}return null},_=i(S.value,n.categoryId);_&&(r=_),y.value={...n,uploadTime:n.createTime,categoryName:r,uploader:n.username||"未知用户",tags:n.tags||[]},U.value=!0}else w.error("获取资料详情失败")}catch(e){console.error("获取资料详情失败:",e),w.error("获取资料详情失败，请检查网络连接")}},q=async t=>{console.log("开始下载资料:",t);const e=localStorage.getItem("user");if(!e){w.error("请先登录"),W.push("/login");return}try{const r=JSON.parse(e).id,i=localStorage.getItem("token");console.log("用户ID:",r),console.log("认证 token:",i);const _=`http://localhost:8082/api/material/download/${t.id}`;console.log("下载API URL:",_);const f=await fetch(`${_}?userId=${r}`,{method:"GET",headers:{Authorization:`Bearer ${i}`}});if(console.log("响应状态:",f.status),console.log("响应状态文本:",f.statusText),!f.ok){const k=await f.json().catch(()=>null);throw k&&k.message?new Error(k.message):new Error(`HTTP error! status: ${f.status}`)}const v=await f.blob();console.log("获取到的blob:",v);const c=window.URL.createObjectURL(v),g=document.createElement("a");g.href=c,g.download=t.fileName||t.name,document.body.appendChild(g),g.click(),document.body.removeChild(g),w.success("下载成功")}catch(n){console.error("下载资料失败:",n),w.error(n.message||"下载失败，请检查网络连接")}};return pe(()=>{Z(),ee(),z()}),(t,e)=>{const n=u("el-button"),r=u("el-input"),i=u("el-card"),_=u("el-option"),f=u("el-select"),v=u("el-tag"),c=u("el-icon"),g=u("el-empty"),k=u("el-table-column"),re=u("el-table"),ie=u("el-pagination"),N=u("el-descriptions-item"),ce=u("el-descriptions"),de=u("el-dialog"),ue=ve("loading");return d(),b("div",Ce,[o(i,{class:"search-card"},{default:l(()=>[o(r,{modelValue:L.value,"onUpdate:modelValue":e[0]||(e[0]=a=>L.value=a),placeholder:"搜索资料",clearable:"","suffix-icon":"el-icon-search",onKeyup:ge(O,["enter"])},{append:l(()=>[o(n,{type:"primary",onClick:O},{default:l(()=>[...e[7]||(e[7]=[m("搜索",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),o(i,{class:"combined-card"},{header:l(()=>[s("div",be,[o(f,{modelValue:K.value,"onUpdate:modelValue":e[1]||(e[1]=a=>K.value=a),onChange:oe},{default:l(()=>[o(_,{label:"最新上传",value:"uploadTime"}),o(_,{label:"最多下载",value:"downloadCount"}),o(_,{label:"最多浏览",value:"viewCount"})]),_:1},8,["modelValue"])])]),default:l(()=>[s("div",Te,[s("div",ze,[e[10]||(e[10]=s("div",{class:"category-header"},[s("h3",null,"资料分类")],-1)),s("div",Ne,[s("div",xe,[o(v,{onClick:e[2]||(e[2]=a=>J(0)),effect:I.value===0&&!V.value?"dark":"plain",class:"category-tag all-category"},{default:l(()=>[...e[8]||(e[8]=[m(" 全部 ",-1)])]),_:1},8,["effect"])]),(d(!0),b(R,null,j(S.value,(a,$)=>(d(),b("div",{key:a.id,class:"roadmap-item"},[s("div",{onClick:x=>ae(a.name),class:Q(["parent-category-container",{expanded:T.value.includes(a.name)}])},[e[9]||(e[9]=s("div",{class:"roadmap-dot"},null,-1)),$<S.value.length-1?(d(),b("div",Se)):E("",!0),s("div",Ve,[o(v,{class:Q(["category-tag parent-category",{active:T.value.includes(a.name)}])},{default:l(()=>[m(h(a.name)+" ",1),a.children&&a.children.length>0?(d(),B(c,{key:0,class:"expand-icon"},{default:l(()=>[T.value.includes(a.name)?(d(),B(A(_e),{key:0})):(d(),B(A(fe),{key:1}))]),_:2},1024)):E("",!0)]),_:2},1032,["class"]),T.value.includes(a.name)&&a.children&&a.children.length>0?(d(),b("div",$e,[s("div",Ie,[(d(!0),b(R,null,j(a.children,x=>(d(),B(v,{key:x.id,onClick:Ae=>J(x.id),effect:I.value===x.id&&!V.value?"dark":"plain",class:"category-tag sub-category"},{default:l(()=>[m(h(x.name),1)]),_:2},1032,["onClick","effect"]))),128))])])):E("",!0)])],10,Be)]))),128))])]),s("div",Me,[H.value.length===0&&!D.value?(d(),b("div",De,[o(g,{description:"暂无资料"})])):he((d(),B(re,{key:1,data:H.value,style:{width:"100%"}},{default:l(()=>[o(k,{prop:"name",label:"资料名称","min-width":"300"},{default:l(a=>[s("a",{href:"#",onClick:ye($=>se(a.row),["prevent"])},h(a.row.name),9,Ue)]),_:1}),o(k,{prop:"categoryName",label:"分类",width:"120"}),o(k,{prop:"uploadTime",label:"上传时间",width:"180"},{default:l(a=>[m(h(G(a.row.uploadTime)),1)]),_:1}),o(k,{prop:"viewCount",label:"浏览",width:"80"}),o(k,{prop:"downloadCount",label:"下载",width:"80"}),o(k,{label:"操作",width:"120"},{default:l(a=>[o(n,{type:"primary",size:"small",onClick:$=>q(a.row)},{default:l(()=>[...e[11]||(e[11]=[m(" 下载 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ue,D.value]]),P.value>0?(d(),b("div",Ee,[o(ie,{"current-page":C.value,"onUpdate:currentPage":e[3]||(e[3]=a=>C.value=a),"page-size":M.value,"onUpdate:pageSize":e[4]||(e[4]=a=>M.value=a),"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",total:P.value,onSizeChange:le,onCurrentChange:ne},null,8,["current-page","page-size","total"])])):E("",!0)])])]),_:1}),o(de,{modelValue:U.value,"onUpdate:modelValue":e[6]||(e[6]=a=>U.value=a),title:y.value.name,width:"80%","destroy-on-close":""},{default:l(()=>[s("div",Fe,[s("div",Le,[o(ce,{column:2,border:""},{default:l(()=>[o(N,{label:"上传者"},{default:l(()=>[m(h(y.value.uploader||"未知"),1)]),_:1}),o(N,{label:"上传时间"},{default:l(()=>[m(h(G(y.value.uploadTime)),1)]),_:1}),o(N,{label:"分类"},{default:l(()=>[m(h(y.value.categoryName),1)]),_:1}),o(N,{label:"浏览次数"},{default:l(()=>[m(h(y.value.viewCount)+"次",1)]),_:1}),o(N,{label:"下载次数"},{default:l(()=>[m(h(y.value.downloadCount)+"次",1)]),_:1}),o(N,{label:"文件大小"},{default:l(()=>[m(h(Y(y.value.fileSize)),1)]),_:1})]),_:1})]),s("div",He,[e[12]||(e[12]=s("h3",null,"资料介绍",-1)),s("p",null,h(y.value.description),1)]),s("div",Ke,[e[13]||(e[13]=s("h3",null,"标签",-1)),(d(!0),b(R,null,j(y.value.tags,(a,$)=>(d(),B(v,{key:$,size:"small",class:"detail-tag",onClick:x=>te(a)},{default:l(()=>[m(h(a),1)]),_:2},1032,["onClick"]))),128))]),s("div",Pe,[o(n,{type:"primary",size:"large",onClick:e[5]||(e[5]=a=>q(y.value))},{default:l(()=>[o(c,null,{default:l(()=>[o(A(we))]),_:1}),e[14]||(e[14]=m(" 下载资料 ",-1))]),_:1})])])]),_:1},8,["modelValue","title"])])}}},qe=ke(Re,[["__scopeId","data-v-feb186a6"]]);export{qe as default};

import{o as I,c as f,a as _,b as r,w as a,t as k,d as U,r as x,e as d,f as v,u as R,g as b,h as g}from"./index-2wzUmdul.js";import{a as m}from"./index-CJj_0Lla.js";import{_ as N}from"./_plugin-vue_export-helper-DlAUqK2U.js";const L={class:"login-container"},C={class:"login-form"},q={key:0,class:"error-message"},A={__name:"Login",setup(B){const i=R(),c=v(null),s=v(""),o=x({username:"",password:"",remember:!1}),w={username:[{required:!0,message:"请输入学号",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"}]},y=async()=>{if(c.value){console.log("开始登录处理..."),console.log("登录表单数据:",o);try{const t=await c.value.validate();if(console.log("表单验证结果:",t),t){console.log("表单验证通过，准备发送登录请求..."),console.log("登录请求参数:",{studentId:o.username,password:o.password});try{console.log("发送登录请求到 /user/login"),console.log("API实例:",m),console.log("API基础URL:",m.defaults.baseURL);const e=await m.post("/user/login",{studentId:o.username,password:o.password});console.log("登录请求成功，响应数据:",e),e.code===200?(console.log("Login response data:",e.data),console.log("User object:",e.data.user),console.log("User role:",e.data.user.role),localStorage.setItem("token",e.data.token),localStorage.setItem("user",JSON.stringify(e.data.user)),console.log("Stored user in localStorage:",JSON.stringify(e.data.user)),o.remember?localStorage.setItem("rememberedUsername",o.username):localStorage.removeItem("rememberedUsername"),s.value="",e.data.user.role===1?(console.log("Admin user, redirecting to /admin"),i.push("/admin")):(console.log("Regular user, redirecting to /home"),i.push("/home")),setTimeout(async()=>{try{const l=await m.get("/user/info");l.code===200&&l.data&&(console.log("强制刷新用户信息成功:",l.data),localStorage.setItem("user",JSON.stringify(l.data)),console.log("已更新localStorage中的用户信息"))}catch(l){console.error("强制刷新用户信息失败:",l)}},500)):(console.log("登录失败，响应消息:",e.message),e.message&&e.message.includes("系统正在更新中")?(console.log("系统正在更新中，显示更新提示..."),s.value="登录请求失败，请稍后重试"):s.value=e.message||"登录失败")}catch(e){console.error("登录请求失败:",e),console.error("错误信息:",e.message),console.error("错误堆栈:",e.stack),e.response?(console.error("错误响应数据:",e.response.data),console.error("错误响应状态:",e.response.status),console.error("错误响应头:",e.response.headers),e.response.data&&e.response.data.message?e.response.data.message.includes("系统正在更新中")?(console.log("系统正在更新中，显示更新提示..."),s.value="登录请求失败，请稍后重试"):s.value=e.response.data.message:s.value="登录请求失败，请稍后重试"):(e.request&&console.error("错误请求:",e.request),s.value="登录请求失败，请稍后重试")}}else console.log("表单验证失败")}catch(t){console.error("表单验证失败:",t),s.value="表单验证失败，请检查输入"}console.log("登录处理完成")}},S=()=>{i.push("/register")};return I(()=>{const t=localStorage.getItem("rememberedUsername");t&&(o.username=t,o.remember=!0)}),(t,e)=>{const l=d("el-input"),n=d("el-form-item"),V=d("el-checkbox"),p=d("el-button"),h=d("el-form");return b(),f("div",L,[_("div",C,[e[6]||(e[6]=_("h2",null,"河南农业大学期末资料共享平台",-1)),r(h,{model:o,rules:w,ref_key:"loginFormRef",ref:c,"label-width":"80px"},{default:a(()=>[r(n,{label:"用户名",prop:"username"},{default:a(()=>[r(l,{modelValue:o.username,"onUpdate:modelValue":e[0]||(e[0]=u=>o.username=u),placeholder:"请输入学号"},null,8,["modelValue"])]),_:1}),r(n,{label:"密码",prop:"password"},{default:a(()=>[r(l,{modelValue:o.password,"onUpdate:modelValue":e[1]||(e[1]=u=>o.password=u),type:"password",placeholder:"请输入密码"},null,8,["modelValue"])]),_:1}),r(n,null,{default:a(()=>[r(V,{modelValue:o.remember,"onUpdate:modelValue":e[2]||(e[2]=u=>o.remember=u),style:{"margin-right":"20px"}},{default:a(()=>[...e[3]||(e[3]=[g("记住账号",-1)])]),_:1},8,["modelValue"])]),_:1}),r(n,null,{default:a(()=>[r(p,{type:"primary",onClick:y,style:{width:"100%"}},{default:a(()=>[...e[4]||(e[4]=[g("登录",-1)])]),_:1})]),_:1}),r(n,null,{default:a(()=>[r(p,{type:"info",onClick:S,style:{width:"100%"}},{default:a(()=>[...e[5]||(e[5]=[g("注册",-1)])]),_:1})]),_:1})]),_:1},8,["model"]),s.value?(b(),f("div",q,k(s.value),1)):U("",!0)])])}}},T=N(A,[["__scopeId","data-v-f34d8ea2"]]);export{T as default};

import{J as O,o as P,c as w,b as t,w as o,E as i,e as c,f as h,u as j,g as m,F as x,A as S,v as b,a as f,t as B,l as L,K as $,h as V,r as K}from"./index-15cpDDQA.js";import{a as U}from"./index-CKeea3vE.js";import{_ as W}from"./_plugin-vue_export-helper-DlAUqK2U.js";const X={class:"upload-container"},Z={class:"card-header"},G={style:{"margin-left":"20px"}},H={__name:"Upload",setup(Q){const D=j(),v=h(null),E=h(null),k=h(!1),p=h([]),F=h([]),l=K({name:"",description:"",categoryId:"",tags:[]}),N={name:[{required:!0,message:"请输入资料名称",trigger:"blur"}],description:[{required:!0,message:"请输入资料描述",trigger:"blur"}],categoryId:[{required:!0,message:"请选择资料分类",trigger:"blur"}],tags:[{required:!0,message:"请选择至少一个标签",trigger:"change",validator:(r,e,d)=>{e.length===0?d(new Error("请选择至少一个标签")):d()}}],file:[{validator:(r,e,d)=>{p.value.length===0?d(new Error("请选择文件")):d()},trigger:"change"}]},q=async()=>{try{const r=await U.get("/category/tree");r.code===200?F.value=r.data:i.error("获取分类失败")}catch(r){console.error("获取分类失败:",r),i.error("获取分类失败，请检查网络连接")}},A=r=>{p.value=[r]},C=async()=>{if(console.log("=== 开始上传 ==="),!v.value){console.log("uploadFormRef不存在");return}const r=localStorage.getItem("user");if(!r){i.error("请先登录");return}const d=JSON.parse(r).id,u=localStorage.getItem("token");if(!u){i.error("请先登录");return}if(console.log("用户信息:",{userId:d,token:u}),console.log("表单数据:",l),console.log("文件列表:",p),p.value.length===0){i.error("请选择文件");return}if(!p.value[0].raw){i.error("文件未正确选择");return}await v.value.validate(async s=>{if(console.log("表单验证结果:",s),s){k.value=!0;try{const n=new FormData;n.append("name",l.name),n.append("description",l.description),n.append("categoryId",l.categoryId),n.append("tags",l.tags.join(",")),n.append("userId",d),n.append("file",p.value[0].raw),console.log("FormData构建完成"),console.log("开始上传文件...");const y=await fetch("/api/material/upload",{method:"POST",headers:{Authorization:`Bearer ${u}`},body:n});console.log("上传请求完成，状态码:",y.status);const g=await y.json();if(console.log("上传响应:",g),g.code===200){i.success(g.message),R();try{const _=await U.get("/user/info",{headers:{Authorization:`Bearer ${u}`}});_.code===200&&(localStorage.setItem("user",JSON.stringify(_.data)),i.success("积分已更新，请查看积分中心"))}catch(_){console.error("获取用户信息失败:",_)}setTimeout(()=>{D.push("/")},1e3)}else i.error(g.message)}catch(n){console.error("上传失败:",n),i.error("上传失败，请检查网络连接")}finally{k.value=!1}}})},R=()=>{v.value&&v.value.resetFields(),p.value=[],l.tags=[]},z=()=>{const r=(d,u)=>{for(const s of d){if(s.id===u)return s;if(s.children&&s.children.length>0){const n=r(s.children,u);if(n)return n}}return null},e=r(F.value,l.categoryId);return e?e.children||[]:[]};return O(()=>l.categoryId,r=>{r&&(l.tags=[])}),P(()=>{q()}),(r,e)=>{const d=c("el-tag"),u=c("el-input"),s=c("el-form-item"),n=c("el-option"),y=c("el-select"),g=c("el-icon"),_=c("el-upload"),T=c("el-button"),J=c("el-form"),M=c("el-card");return m(),w("div",X,[t(M,{class:"upload-form-card"},{header:o(()=>[f("div",Z,[e[5]||(e[5]=f("span",null,"上传资料",-1)),t(d,{type:"success"},{default:o(()=>[...e[4]||(e[4]=[V("上传成功可获得20积分奖励",-1)])]),_:1})])]),default:o(()=>[t(J,{model:l,rules:N,ref_key:"uploadFormRef",ref:v,"label-width":"100px"},{default:o(()=>[t(s,{label:"资料名称",prop:"name"},{default:o(()=>[t(u,{modelValue:l.name,"onUpdate:modelValue":e[0]||(e[0]=a=>l.name=a),placeholder:"请输入资料名称"},null,8,["modelValue"])]),_:1}),t(s,{label:"资料描述",prop:"description"},{default:o(()=>[t(u,{modelValue:l.description,"onUpdate:modelValue":e[1]||(e[1]=a=>l.description=a),type:"textarea",rows:3,placeholder:"请输入资料描述"},null,8,["modelValue"])]),_:1}),t(s,{label:"资料分类",prop:"categoryId"},{default:o(()=>[t(y,{modelValue:l.categoryId,"onUpdate:modelValue":e[2]||(e[2]=a=>l.categoryId=a),placeholder:"请选择资料分类"},{default:o(()=>[(m(!0),w(x,null,S(F.value,a=>(m(),b(n,{key:a.id,label:a.name,value:a.id},{default:o(()=>[f("span",null,B(a.name),1),(m(!0),w(x,null,S(a.children,I=>(m(),b(n,{key:I.id,label:I.name,value:I.id},{default:o(()=>[f("span",G,B(I.name),1)]),_:2},1032,["label","value"]))),128))]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(s,{label:"标签",prop:"tags"},{default:o(()=>[t(y,{modelValue:l.tags,"onUpdate:modelValue":e[3]||(e[3]=a=>l.tags=a),multiple:"",placeholder:"请先选择资料分类",style:{width:"100%"},disabled:!l.categoryId},{default:o(()=>[l.categoryId?(m(!0),w(x,{key:0},S(z(),a=>(m(),b(n,{key:a.id,label:a.name,value:a.name},{default:o(()=>[f("span",null,B(a.name),1)]),_:2},1032,["label","value"]))),128)):(m(),b(n,{key:1,label:"请先选择资料分类",value:"",disabled:""}))]),_:1},8,["modelValue","disabled"])]),_:1}),t(s,{label:"选择文件",prop:"file"},{default:o(()=>[t(_,{class:"upload-demo",ref_key:"upload",ref:E,"auto-upload":!1,"on-change":A,limit:1,"file-list":p.value,accept:".pdf,.doc,.docx,.txt,.zip,.rar",drag:""},{tip:o(()=>[...e[6]||(e[6]=[f("div",{class:"el-upload__tip"}," 支持上传 PDF、Word、TXT、ZIP、RAR 格式文件，单个文件大小不超过 100MB ",-1)])]),default:o(()=>[t(g,{class:"el-icon--upload"},{default:o(()=>[t(L($))]),_:1}),e[7]||(e[7]=f("div",{class:"el-upload__text"},[V(" 拖拽文件到此处，或 "),f("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1}),t(s,null,{default:o(()=>[t(T,{type:"primary",onClick:C,loading:k.value},{default:o(()=>[...e[8]||(e[8]=[V("上传",-1)])]),_:1},8,["loading"]),t(T,{onClick:R},{default:o(()=>[...e[9]||(e[9]=[V("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})])}}},oe=W(H,[["__scopeId","data-v-d75521d9"]]);export{oe as default};
